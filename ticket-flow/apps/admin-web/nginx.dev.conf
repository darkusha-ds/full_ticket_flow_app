events {}

http {
  upstream admin_web {
    server admin-web:3000;
  }

  upstream api_upstream {
    server api:8000;
  }

  server {
    listen 80;

    # ---- API ----
    location /api/ {
      proxy_pass http://api_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ---- ADMIN (CRA dev server) ----
    # Primary path that CRA is currently built for (because PUBLIC_URL is set to /vision-ui-dashboard-react)
    location /vision-ui-dashboard-react/ {
      proxy_pass http://admin_web/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
    }

    location = /vision-ui-dashboard-react {
      return 301 /vision-ui-dashboard-react/;
    }

    # Backwards-compatible alias: /dashboard -> same CRA app
    location /dashboard/ {
      return 301 /vision-ui-dashboard-react/;
    }

    location = /dashboard {
      return 301 /dashboard/;
    }

    # CRA websocket (react-scripts). Support both old and new paths.
    location /ws {
      proxy_pass http://admin_web/ws;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
    }

    location /vision-ui-dashboard-react/ws {
      proxy_pass http://admin_web/ws;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
    }

    # If you want the site root to go to the dashboard
    location = / {
      return 301 /vision-ui-dashboard-react/;
    }
  }
}