generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * Multi-tenant core:
 * - Tenant = клиент/организатор (workspace)
 * - User может состоять в нескольких tenant (через Membership)
 */

enum UserRole {
  OWNER
  ADMIN
  MEMBER
}

enum BotStatus {
  ONLINE
  OFFLINE
  DISABLED
}

enum EventStatus {
  DRAFT
  ACTIVE
  PAUSED
  FINISHED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELED
  REFUNDED
}

enum PaymentProvider {
  TELEGRAM
  YOOKASSA
  STRIPE
  MANUAL
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  bots        Bot[]
  events      Event[]
  orders      Order[]
  payments    Payment[]
  payouts     Payout[]

  ticketTypes TicketType[] @relation("TenantTicketTypes")

  @@index([createdAt])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships Membership[]

  @@index([createdAt])
}

model Membership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  role      UserRole @default(MEMBER)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([userId])
  @@index([tenantId])
}

model Bot {
  id        String    @id @default(cuid())
  tenantId  String
  name      String
  username  String?
  slug      String    @unique
  status    BotStatus @default(OFFLINE)

  telegramBotId  String?
  tokenEncrypted String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  events Event[]

  @@index([tenantId, createdAt])
  @@index([status])
}

model Event {
  id          String      @id @default(cuid())
  tenantId    String
  botId       String?
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime?
  venue       String?
  status      EventStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bot    Bot?   @relation(fields: [botId], references: [id], onDelete: SetNull)

  ticketTypes TicketType[]
  orders      Order[]

  @@index([tenantId, startsAt])
  @@index([status])
  @@index([botId])
}

model TicketType {
  id       String @id @default(cuid())
  tenantId String
  eventId  String
  name     String
  price    Int
  currency String  @default("RUB")
  capacity Int?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tenant Tenant @relation("TenantTicketTypes", fields: [tenantId], references: [id], onDelete: Cascade)

  orderItems OrderItem[]

  @@index([eventId])
  @@index([tenantId])
}

model Order {
  id      String      @id @default(cuid())
  tenantId String
  eventId  String
  status  OrderStatus @default(PENDING)

  buyerTelegramId String?
  buyerName       String?
  buyerUsername   String?

  totalAmount Int
  currency    String @default("RUB")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  items   OrderItem[]
  payment Payment?

  @@index([tenantId, createdAt])
  @@index([eventId])
  @@index([status])
}

model OrderItem {
  id           String @id @default(cuid())
  orderId      String
  ticketTypeId String
  quantity     Int    @default(1)
  unitPrice    Int

  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([ticketTypeId])
}

model Payment {
  id      String        @id @default(cuid())
  tenantId String
  orderId  String        @unique

  provider PaymentProvider
  status   PaymentStatus  @default(PENDING)

  amount   Int
  currency String @default("RUB")

  providerPaymentId String?
  raw               Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([status])
}

model Payout {
  id      String @id @default(cuid())
  tenantId String

  amount   Int
  currency String @default("RUB")
  status   String

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
}